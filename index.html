<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro de Cursos ITD</title>
    <!-- Incluye Tailwind CSS para un diseño moderno y responsive -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        /* Estilo para el modal */
        .modal {
            transition: opacity 0.3s ease-in-out;
        }
        .modal-active {
            opacity: 1;
            pointer-events: auto;
        }
        /* Estilos para las opciones de curso con color de fondo alternado */
        .course-option-group-1 { background-color: #ebf8ff; /* blue-50 */ }
        .course-option-group-2 { background-color: #e0e7ff; /* indigo-50 */ }
        .course-option-group-3 { background-color: #ffe6e6; /* red-50 (opcional) */ }
        /* Clases para deshabilitar la entrada de texto */
        .input-disabled {
            background-color: #e5e7eb; /* gray-200 más claro */
            cursor: not-allowed;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">

    <!-- Contenedor principal del formulario -->
    <div class="bg-white p-6 md:p-10 rounded-2xl shadow-2xl w-full max-w-4xl border border-gray-200">
        
        <!-- Encabezado con Logo y Títulos -->
        <div class="flex flex-col justify-center items-center text-center mb-6 border-b pb-4">
            <!-- Logo ITD (AUMENTADO A h-20) -->
            <img src="https://raw.githubusercontent.com/DA-itd/web/main/logo_itdurango.png" alt="Logo ITD" class="h-20 w-auto object-contain mb-4">
            <div class="w-full">
                <h2 class="text-xl font-semibold text-gray-700">INSTITUTO TECNOLOGICO DE DURANGO</h2>
                <h1 class="text-3xl font-bold text-gray-800">Registro de Cursos de Actualización Docente</h1>
            </div>
        </div>
        
        <!-- Mensaje de Carga -->
        <div id="loadingMessage" class="p-4 bg-yellow-100 text-yellow-800 rounded-xl text-center font-semibold mb-4">
            Cargando datos de cursos y docentes desde GitHub...
        </div>

        <!-- Formulario -->
        <!-- La URL del action debe ser el endpoint de tu Google Apps Script para registrar la inscripción -->
        <form id="registroForm" class="space-y-6 hidden" action="https://script.google.com/macros/s/AKfycbyxWZVL33x5pXJQ01Bug4ALTVT43xSSBzoZr1D5A58wlU4Tnvxj9AomY/exec" method="POST">
            
            <!-- Campos de Información Personal -->
            <div id="personalInfoFields" class="grid grid-cols-1 md:grid-cols-2 gap-6 p-4 border rounded-xl bg-blue-50/50">
                
                <!-- Nombre Completo (CON AUTOCLOMPLETADO) -->
                <div>
                    <label for="nombreCompleto" class="block text-sm font-medium text-gray-700">Nombre Completo</label>
                    <input type="text" id="nombreCompleto" name="nombreCompleto" required 
                           class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-xl shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 uppercase" 
                           oninput="this.value = this.value.toUpperCase()"
                           list="docentesList" onchange="autofillDocente(this.value)">
                    <datalist id="docentesList">
                        <!-- Opciones pobladas por JS -->
                    </datalist>
                </div>

                <!-- CURP -->
                <div>
                    <label for="curp" class="block text-sm font-medium text-gray-700">CURP</label>
                    <!-- ATRIBUTO REQUIRED PARA REQUERIR EL LLENADO -->
                    <input type="text" id="curp" name="curp" maxlength="18" required 
                           class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-xl shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 uppercase" 
                           oninput="this.value = this.value.toUpperCase()">
                </div>

                <!-- Email -->
                <div>
                    <label for="email" class="block text-sm font-medium text-gray-700">Correo Electrónico</label>
                    <!-- ATRIBUTO REQUIRED PARA REQUERIR EL LLENADO -->
                    <input type="email" id="email" name="email" required 
                           class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-xl shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" 
                           placeholder="usuario@itdurango.edu.mx o usuario@gmail.com">
                </div>

                <!-- Género -->
                <div>
                    <label for="genero" class="block text-sm font-medium text-gray-700">Género</label>
                    <select id="genero" name="genero" required 
                            class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-xl shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                        <option value="">Selecciona tu género</option>
                        <option value="Femenino">Femenino</option>
                        <option value="Masculino">Masculino</option>
                        <option value="Otro">Otro</option>
                    </select>
                </div>

                <!-- Departamento (Siempre activo para ser seleccionado o modificado) -->
                <div class="col-span-1 md:col-span-2">
                    <label for="departamento" class="block text-sm font-medium text-gray-700">Departamento</label>
                    <select id="departamento" name="departamento" required 
                            class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-xl shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                        <option value="">Cargando departamentos...</option>
                        <!-- Opciones pobladas desde GitHub -->
                    </select>
                </div>
            </div>

            <!-- Sección de Cursos a Inscribir -->
            <div class="p-4 border rounded-xl bg-green-50/50">
                <h3 class="text-lg font-semibold mb-4 text-gray-700">Selección de Curso</h3>
                
                <!-- Campo: Curso Seleccionado (Debe estar siempre activo) -->
                <div class="mb-4">
                    <label for="curso" class="block text-sm font-medium text-gray-700">Curso a Inscribir</label>
                    <select id="curso" name="cursoSeleccionado" required 
                            class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-xl shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" 
                            onchange="updateCourseDetails()">
                        <option value="">Cargando cursos...</option>
                        <!-- Opciones pobladas desde GitHub con colores -->
                    </select>
                </div>

                <!-- Detalles del Curso Seleccionado (Información visible y campos hidden para el envío) -->
                <div id="courseDetailsBlock" class="grid grid-cols-1 md:grid-cols-3 gap-4 p-3 bg-green-100 rounded-xl border border-green-300 hidden">
                    
                    <!-- Fecha Visible -->
                    <div>
                        <label class="block text-xs font-medium text-gray-600">Fecha Visible</label>
                        <p id="detailFechaVisible" class="text-sm font-semibold text-gray-800"></p>
                        <input type="hidden" id="fechaVisible" name="fechaVisible">
                    </div>
                    
                    <!-- Lugar -->
                    <div>
                        <label class="block text-xs font-medium text-gray-600">Lugar</label>
                        <p id="detailLugar" class="text-sm font-semibold text-gray-800"></p>
                        <input type="hidden" id="lugar" name="lugar">
                    </div>

                    <!-- Horario -->
                    <div>
                        <label class="block text-xs font-medium text-gray-600">Horario</label>
                        <p id="detailHorario" class="text-sm font-semibold text-gray-800"></p>
                        <input type="hidden" id="horario" name="horario">
                    </div>
                </div>
            </div>

            <!-- Lista de Cursos Registrados Temporalmente -->
            <div id="registeredCoursesContainer" class="p-4 border border-yellow-300 bg-yellow-50 rounded-xl hidden">
                <h3 class="text-lg font-semibold mb-2 text-gray-700">Cursos Agregados (Máx. 3)</h3>
                <ul id="registeredCoursesList" class="list-disc list-inside text-sm text-gray-600 ml-4">
                    <!-- Cursos agregados aquí -->
                </ul>
            </div>

            <!-- Botón de Envío -->
            <div class="pt-4">
                <button type="button" id="aceptarButton" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-xl shadow-sm text-lg font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-300 ease-in-out transform hover:scale-105">
                    Aceptar
                </button>
                <p id="error-message" class="mt-2 text-center text-red-600 font-medium hidden"></p>
            </div>
        </form>

        <!-- Mensaje de éxito final -->
        <div id="successMessage" class="mt-6 p-6 bg-green-100 text-green-800 rounded-xl hidden text-center">
            <h3 class="font-bold text-xl mb-2">¡Registro Completado con Éxito!</h3>
            <p class="mt-1">Tus cursos han sido inscritos. Revisa tu correo electrónico para las confirmaciones.</p>
        </div>
    </div>

    <!-- Modal Personalizado para el Flujo de Múltiples Cursos/Confirmación -->
    <div id="customModal" class="modal fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 opacity-0 pointer-events-none z-50">
        <div class="bg-white p-6 rounded-2xl shadow-xl w-full max-w-sm transform transition-all duration-300 scale-95 modal-content">
            <h4 id="modalTitle" class="text-lg font-bold text-gray-800 mb-4"></h4>
            <p id="modalMessage" class="text-gray-600 mb-6"></p>
            <div id="modalButtons" class="flex justify-end space-x-3">
                <!-- Botones generados por JS -->
            </div>
        </div>
    </div>

    <!-- JavaScript con Datos y Lógica -->
    <script>
        // URLs de los archivos de datos en GitHub (USANDO RAW URLS PARA ACCEDER AL CONTENIDO PURO)
        const COURSES_URL = 'https://raw.githubusercontent.com/DA-itd/web/main/cursos.csv'; 
        const DEPARTMENTS_URL = 'https://raw.githubusercontent.com/DA-itd/web/main/departamentos.csv'; 
        const DOCENTES_URL = 'https://raw.githubusercontent.com/DA-itd/web/main/docentes.csv'; 
        
        // Variables globales para almacenar los datos cargados
        let COURSES = [];
        let DEPARTMENTS = [];
        let DOCENTES_LIST = []; 
        let DOCENTES_MAP = {}; 

        let registeredCourses = JSON.parse(localStorage.getItem('registeredCourses')) || [];
        const form = document.getElementById('registroForm');
        const aceptarButton = document.getElementById('aceptarButton');
        const personalInfoFields = document.getElementById('personalInfoFields');
        const successMessage = document.getElementById('successMessage');
        const courseDetailsBlock = document.getElementById('courseDetailsBlock');
        const loadingMessage = document.getElementById('loadingMessage');
        
        // --- Función mejorada y robusta para parsear CSV (FIX CRÍTICO #2) ---
        /**
         * Convierte una cadena de texto CSV a un array de objetos JSON de forma robusta.
         * Se le pasa un tipo de dato para manejar encabezados ausentes o incorrectos (Ej: docentes.csv).
         * @param {string} csvText - La cadena de texto del archivo CSV.
         * @param {string} dataType - 'cursos', 'departamentos', 'docentes'.
         * @returns {Array<Object>} Array de objetos donde cada objeto es una fila.
         */
        function parseCSV(csvText, dataType) {
            // Define encabezados esperados para archivos sin ellos o con errores
            const expectedHeaders = {
                'docentes': ['NombreCompleto', 'Curp', 'Email'],
                'departamentos': ['NombreDepartamento'],
                // Usamos una lista más completa para cursos si la primera línea no es clara
                'cursos': ['NombreCurso', 'FechaVisible', 'Periodo', 'Horas', 'Lugar', 'Horario'] 
            };

            const lines = csvText.split('\n').map(line => line.trim()).filter(line => line.length > 0);
            if (lines.length === 0) return [];

            let headers = [];
            let dataLines = lines;

            // Intenta leer la primera línea como encabezado
            const firstLine = lines[0];
            const sampleValues = firstLine.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
            
            // Verificación heurística: si la primera línea se parece a un encabezado esperado, la usamos.
            // Si el primer campo coincide con el primer campo del encabezado esperado, lo tratamos como encabezado.
            const isHeader = expectedHeaders[dataType] && sampleValues.length === expectedHeaders[dataType].length && 
                             (sampleValues[0].replace(/"/g, '').trim() === expectedHeaders[dataType][0]);

            if (isHeader) {
                // Si es un encabezado válido, lo usamos y pasamos a la siguiente línea para los datos
                headers = firstLine.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(h => h.trim().replace(/"/g, ''));
                dataLines = lines.slice(1);
            } else {
                // Si no se parece al encabezado o falta, usamos el encabezado esperado y procesamos TODAS las líneas como datos.
                headers = expectedHeaders[dataType];
                dataLines = lines; // Todas las líneas son datos
                console.warn(`[CSV_WARN] El archivo ${dataType}.csv no contenía el encabezado esperado. Usando encabezados predefinidos: ${headers.join(', ')}.`);
            }
            
            const numHeaders = headers.length;
            const result = [];
            // Regex para dividir campos: busca comas que NO estén dentro de comillas dobles.
            const separatorRegex = /,(?=(?:(?:[^"]*"){2})*[^"]*$)/;

            for (const line of dataLines) {
                if (line.trim() === '') continue;

                let values = line.split(separatorRegex);

                // Si hay más valores de los que debería haber, es posible que el regex fallara o que la línea esté mal.
                if (values.length !== numHeaders) {
                    // Si el archivo es Docentes.csv y tiene 4 campos (error común al haber un campo extra)
                    if (dataType === 'docentes' && values.length === 4) {
                        // Ignoramos el último campo si el número de valores no coincide con el encabezado de 3 campos
                         values = values.slice(0, 3);
                    } else if (dataType === 'cursos' && values.length > numHeaders) {
                        // Para cursos, si hay más, podría ser porque un NombreCurso tenía más comas de lo esperado o una línea incompleta.
                         console.warn(`[CSV_WARN] Línea omitida en ${dataType} por desajuste: Esperado ${numHeaders}, encontrado ${values.length}. Línea: ${line}`);
                         continue; 
                    } else if (values.length !== numHeaders) {
                         console.warn(`[CSV_WARN] Línea omitida en ${dataType} por desajuste: Esperado ${numHeaders}, encontrado ${values.length}. Línea: ${line}`);
                         continue; 
                    }
                }
                
                const obj = {};
                for (let j = 0; j < numHeaders; j++) {
                    let val = (values[j] || '').trim();
                    
                    // Limpiar comillas dobles circundantes
                    if (val.startsWith('"') && val.endsWith('"') && val.length > 1) {
                        val = val.substring(1, val.length - 1).replace(/""/g, '"').trim();
                    }
                    
                    obj[headers[j]] = val;
                }

                // Solo añadir si el primer campo no está vacío
                const firstHeader = headers[0];
                if (obj[firstHeader] && obj[firstHeader].trim() !== '') { 
                    result.push(obj);
                }
            }
            return result;
        }

        // --- Funciones de Carga de Datos desde GitHub (SIN CAMBIOS, usa la nueva parseCSV) ---
        async function loadExternalData() {
            try {
                // Función auxiliar para cargar y parsear cualquier CSV
                const fetchAndParseCSV = async (url, type) => {
                    const response = await fetch(url);
                    const csvText = await response.text();
                    return parseCSV(csvText, type);
                };

                // 1. Cargar Cursos (CSV)
                const rawCourses = await fetchAndParseCSV(COURSES_URL, 'cursos');
                // Aseguramos que NombreCurso exista y sea string válido
                COURSES = rawCourses.filter(c => c.NombreCurso && typeof c.NombreCurso === 'string' && c.NombreCurso.trim() !== '');
                
                // 2. Cargar Departamentos (CSV)
                const rawDepartments = await fetchAndParseCSV(DEPARTMENTS_URL, 'departamentos');
                // Mapeamos solo el valor del departamento y filtramos strings no vacíos
                DEPARTMENTS = rawDepartments.map(d => d.NombreDepartamento).filter(d => typeof d === 'string' && d.trim() !== ''); 
                
                // 3. Cargar Docentes (CSV)
                const docentesData = await fetchAndParseCSV(DOCENTES_URL, 'docentes');
                DOCENTES_LIST = docentesData; 
                
                // Crear el mapa de búsqueda para autocompletado/validación
                DOCENTES_MAP = docentesData.reduce((acc, doc) => {
                    // Mapeo por Nombre Completo
                    const nombreUpper = (doc.NombreCompleto || '').toUpperCase();
                    if (nombreUpper) acc[nombreUpper] = doc;
                    
                    // Mapeo por CURP (si existe)
                    if (doc.Curp && doc.Curp.trim() !== '') acc[doc.Curp.toUpperCase()] = doc;
                    
                    // Mapeo por Email (si existe)
                    if (doc.Email && doc.Email.trim() !== '') acc[doc.Email.toLowerCase()] = doc;
                    
                    return acc;
                }, {});

                // Validación de datos mínimos
                if (COURSES.length === 0 || DEPARTMENTS.length === 0 || DOCENTES_LIST.length === 0) {
                     console.error("[CONSOLE_ERROR] Algunos datos esenciales están vacíos después del parseo.");
                     loadingMessage.textContent = "Error: Faltan datos esenciales (cursos, docentes o departamentos). Verifica los archivos CSV.";
                     loadingMessage.classList.add('bg-red-100', 'text-red-800');
                     // Mostrar los conteos para depuración
                     console.log(`Cursos cargados: ${COURSES.length}, Departamentos cargados: ${DEPARTMENTS.length}, Docentes cargados: ${DOCENTES_LIST.length}`);
                     return;
                }

                // Si todo está bien, inicializar la interfaz
                populateDropdowns();
                populateDocentesDatalist(); 
                renderRegisteredCourses();
                updateCourseDetails(); 
                loadingMessage.classList.add('hidden');
                form.classList.remove('hidden');

            } catch (error) {
                console.error("Error al cargar los datos desde GitHub:", error);
                loadingMessage.textContent = "Error al cargar los datos. Por favor, verifica las URL de los archivos CSV.";
                loadingMessage.classList.add('bg-red-100', 'text-red-800');
                populateDropdowns(); 
            }
        }


        // --- Funciones de Autocompletado y Utilidad (SIN CAMBIOS FUNCIONALES) ---

        // Función para poblar la lista de autocompletado de docentes
        function populateDocentesDatalist() {
            const datalist = document.getElementById('docentesList');
            datalist.innerHTML = '';
            
            DOCENTES_LIST.forEach(doc => {
                if (doc.NombreCompleto) {
                    const option = document.createElement('option');
                    option.value = doc.NombreCompleto.toUpperCase();
                    datalist.appendChild(option);
                }
            });
        }
        
        // Función para autocompletar campos cuando se selecciona un docente
        window.autofillDocente = function(selectedName) {
            const upperName = selectedName.toUpperCase();
            // Buscar por nombre
            const docente = DOCENTES_LIST.find(doc => (doc.NombreCompleto || '').toUpperCase() === upperName);
            
            if (docente) {
                const curpField = document.getElementById('curp');
                const emailField = document.getElementById('email');

                // Autocompletar y bloquear si el valor existe en el CSV
                const curpValue = (docente.Curp || '').toUpperCase().trim();
                const emailValue = (docente.Email || '').toLowerCase().trim();
                
                curpField.value = curpValue;
                emailField.value = emailValue;
                
                // Solo deshabilitar el campo si tiene un valor que vino del CSV
                setFieldDisabled(curpField, curpValue !== '');
                setFieldDisabled(emailField, emailValue !== '');
                
                // Si la columna 'Departamento' existe en el CSV de Docentes, la usamos (aunque tu CSV no la tiene)
                const departamentoSelect = document.getElementById('departamento');
                if (docente.Departamento && departamentoSelect) { 
                    departamentoSelect.value = docente.Departamento || ''; 
                } 
                
            } else {
                // Si el nombre no coincide, habilitar todos los campos de identificación (quitar bloqueo)
                setFieldDisabled(document.getElementById('curp'), false);
                setFieldDisabled(document.getElementById('email'), false);
            }
            
            // Asegurar que el campo de Nombre Completo siempre esté en mayúsculas
            document.getElementById('nombreCompleto').value = upperName;
        }

        /**
         * Aplica o quita el estado de readOnly y el estilo de deshabilitado a un campo.
         * @param {HTMLElement} field - El elemento de input.
         * @param {boolean} isDisabled - True para bloquear, False para habilitar.
         */
        function setFieldDisabled(field, isDisabled) {
             if (field) { 
                field.readOnly = isDisabled;
                if (isDisabled) {
                    field.classList.add('input-disabled');
                } else {
                    field.classList.remove('input-disabled');
                }
            }
        }

        // Función para habilitar/deshabilitar campos de información personal
        function setPersonalInfoFieldsDisabled(isDisabled) {
            
            // Campos que DEBEN bloquearse al tener cursos registrados: CURP y Email.
            // Esto asegura que el mismo docente envíe todos los cursos.
            const curpField = document.getElementById('curp');
            const emailField = document.getElementById('email');

            // Itera sobre los campos de input (CURP, Email)
            [curpField, emailField].forEach(field => {
                // Solo bloquear si tiene contenido. Si el contenido está vacío (porque vino vacío del CSV), 
                // entonces forzamos la NO desactivación para que el usuario pueda escribir.
                if (field) {
                    const shouldBeReadOnly = isDisabled && field.value.trim() !== '';
                    setFieldDisabled(field, shouldBeReadOnly);
                }
            });
            
            // Departamento y Genero SIEMPRE ACTIVOS (disabled=false)
            const activeFields = [
                document.getElementById('departamento'),
                document.getElementById('genero')
            ];

            activeFields.forEach(field => {
                if (field) {
                    field.disabled = false;
                    field.classList.remove('input-disabled');
                }
            });
            
            // El campo de curso (#curso) SIEMPRE ACTIVO
            document.getElementById('curso').disabled = false;
        }


        // Función para poblar los dropdowns con diferenciación de color por fecha
        function populateDropdowns() {
            const departamentoSelect = document.getElementById('departamento');
            const cursoSelect = document.getElementById('curso');
            
            // 1. Departamentos
            departamentoSelect.innerHTML = '<option value="">Selecciona un departamento</option>';
            DEPARTMENTS.forEach(dept => {
                const option = document.createElement('option');
                option.value = dept;
                option.textContent = dept;
                departamentoSelect.appendChild(option);
            });

            // 2. Cursos (Revisión de Data)
            cursoSelect.innerHTML = ''; // Limpiar completamente

            // Si después del filtro, no hay cursos válidos
            if (COURSES.length === 0) {
                // Si no hay cursos cargados, actualizar el mensaje del placeholder con error
                cursoSelect.innerHTML = '<option value="" disabled>ERROR: No se encontraron cursos con nombre válido</option>';
                console.error("Los datos de cursos se cargaron, pero no contenían nombres válidos.");
                // Estilo visual de error
                cursoSelect.classList.add('border-red-500', 'text-red-500', 'focus:ring-red-500', 'focus:border-red-500');
                return; // Salir de la función
            }
            
            // Añadir placeholder inicial
            cursoSelect.innerHTML = '<option value="">Selecciona un curso</option>';
            cursoSelect.classList.remove('border-red-500', 'text-red-500', 'focus:ring-red-500', 'focus:border-red-500');

            // Agrupar cursos por FechaVisible
            const coursesByDate = COURSES.reduce((acc, course) => {
                // Asegurar que solo se procesen objetos con un NombreCurso válido aquí también
                if (course.NombreCurso) { 
                    const dateKey = course.FechaVisible ? String(course.FechaVisible).trim() : 'Sin Fecha';
                    if (!acc[dateKey]) {
                        acc[dateKey] = [];
                    }
                    acc[dateKey].push(course);
                }
                return acc;
            }, {});

            let groupIndex = 1;
            // Ordenar las fechas para que los grupos aparezcan ordenados
            const sortedDates = Object.keys(coursesByDate).sort(); 

            sortedDates.forEach(date => {
                const coursesInGroup = coursesByDate[date];
                
                // Si hay cursos válidos en el grupo
                if (coursesInGroup.length > 0) {
                    const optgroup = document.createElement('optgroup');
                    optgroup.label = `--- ${date} ---`;
                    optgroup.className = `course-option-group-${groupIndex}`;

                    coursesInGroup.forEach(curso => {
                        const option = document.createElement('option');
                        option.value = curso.NombreCurso;
                        option.textContent = curso.NombreCurso;
                        optgroup.appendChild(option);
                    });
                    
                    cursoSelect.appendChild(optgroup);
                    // Alternar el color del grupo (1, 2, 3)
                    groupIndex = groupIndex % 3 + 1;
                }
            });
            
            // Post-check: Si solo queda el placeholder, es un problema de datos
            if (cursoSelect.children.length === 1 && cursoSelect.children[0].value === "") {
                console.warn("Advertencia: El selector de cursos sigue vacío tras intentar poblarlo.");
            }
        }

        // Función para actualizar los campos de detalle del curso
        function updateCourseDetails() {
            const cursoSelect = document.getElementById('curso');
            const selectedCourseName = cursoSelect.value;
            // Buscar el curso por el nombre (NombreCurso)
            const curso = COURSES.find(c => c.NombreCurso === selectedCourseName); 

            if (curso && selectedCourseName !== '') {
                // FIX: Usar el operador OR (|| '') para asegurar que no se asignen valores 'undefined'
                const fechaVisible = curso.FechaVisible || '';
                const lugar = curso.Lugar || '';
                const horario = curso.Horario || '';
                
                // Actualizar los inputs hidden para el envío del formulario
                document.getElementById('fechaVisible').value = fechaVisible;
                document.getElementById('lugar').value = lugar;
                document.getElementById('horario').value = horario;

                // Actualizar los detalles visibles
                document.getElementById('detailFechaVisible').textContent = fechaVisible;
                document.getElementById('detailLugar').textContent = lugar;
                document.getElementById('detailHorario').textContent = horario;
                courseDetailsBlock.classList.remove('hidden');

            } else {
                // Limpiar si no hay curso seleccionado (o si se selecciona el placeholder)
                document.getElementById('fechaVisible').value = '';
                document.getElementById('lugar').value = '';
                document.getElementById('horario').value = '';
                // Limpiar detalles visibles
                document.getElementById('detailFechaVisible').textContent = '';
                document.getElementById('detailLugar').textContent = '';
                document.getElementById('detailHorario').textContent = '';
                courseDetailsBlock.classList.add('hidden');
            }
        }

        // Función para renderizar la lista de cursos registrados
        function renderRegisteredCourses() {
            const list = document.getElementById('registeredCoursesList');
            const container = document.getElementById('registeredCoursesContainer');
            list.innerHTML = '';
            
            
            if (registeredCourses.length > 0) {
                container.classList.remove('hidden');
                registeredCourses.forEach((reg, index) => {
                    const li = document.createElement('li');
                    li.innerHTML = `<strong>${reg.cursoSeleccionado}</strong> (${reg.fechaVisible || 'N/A'} | ${reg.horario || 'N/A'}) 
                                    <button onclick="removeCourse(${index})" class="ml-2 text-red-500 hover:text-red-700 text-xs font-bold transition duration-150">BORRAR</button>`;
                    list.appendChild(li);
                });
                
                // Bloquear CURP y Email para mantener consistencia en el envío
                setPersonalInfoFieldsDisabled(true);

                if (registeredCourses.length >= 3) {
                    aceptarButton.textContent = 'FINALIZAR REGISTRO (3 Cursos)';
                } else {
                    aceptarButton.textContent = 'AÑADIR OTRO CURSO';
                }

            } else {
                container.classList.add('hidden');
                // Habilitar CURP y Email si no hay cursos registrados
                // Esto se hace en autofillDocente() al limpiar el campo o si no se encuentra el docente
                // Aquí solo aseguramos que no se bloqueen por el contador.
                // La lógica de bloqueo por contenido la maneja autofillDocente y setFieldDisabled.
                aceptarButton.textContent = 'Aceptar'; 
            }
        }

        // Función para eliminar un curso de la lista temporal
        function removeCourse(index) {
            registeredCourses.splice(index, 1);
            localStorage.setItem('registeredCourses', JSON.stringify(registeredCourses));
            renderRegisteredCourses();
            updateCourseDetails(); 
            showModal('Curso Eliminado', 'El curso fue eliminado de tu lista temporal.', 'Aceptar');
        }
        window.removeCourse = removeCourse; 

        // Función de validación de correo electrónico de dominio ITD/Gmail
        function validateEmailDomain(email) {
            const regex = /^[a-zA-Z0-9._%+-]+@((itdurango\.edu\.mx)|(gmail\.com))$/i;
            return regex.test(email);
        }
        
        // Función de validación de existencia de docente
        function validateDocenteExistence(curp, email, nombre) {
             // Buscamos por Nombre Completo
            const nameFound = DOCENTES_LIST.find(doc => (doc.NombreCompleto || '').toUpperCase() === nombre.toUpperCase());

            if (nameFound) {
                // Si el nombre existe, el docente es válido. 
                // La CURP y Email deben llenarse si o si gracias al atributo 'required' en el HTML.
                return null; // Docente encontrado
            }
            return "Tu Nombre Completo no fue encontrado en la base de datos de Docentes. Por favor, verifica tus datos o contacta a la administración.";
        }


        // Función de validación de traslape
        function checkOverlap(newCourseName) {
            const newCourseData = COURSES.find(c => c.NombreCurso === newCourseName);
            
            if (!newCourseData || newCourseName === '') { 
                return "Debes seleccionar un curso de la lista.";
            }

            // Regla 1: Curso ya en la lista
            if (registeredCourses.some(reg => reg.cursoSeleccionado === newCourseData.NombreCurso)) {
                return `El curso "${newCourseData.NombreCurso}" ya está en tu lista de inscripciones temporales.`;
            }

            // Regla 2: No empalme de Fecha y Horario
            const overlap = registeredCourses.find(reg => 
                reg.fechaVisible === newCourseData.FechaVisible && reg.horario === newCourseData.Horario
            );
            
            if (overlap) {
                return `El curso se empalma con "${overlap.cursoSeleccionado}", que tiene la misma fecha y horario (${overlap.fechaVisible} | ${overlap.horario}).`;
            }

            // Regla 3: Máximo 3 cursos
            if (registeredCourses.length >= 3) {
                return "Has alcanzado el límite máximo de 3 cursos.";
            }

            return null; // No hay errores
        }
        
        // Funciones de Modal
        function showModal(title, message, buttonText, actionFunction = null) {
            const modal = document.getElementById('customModal');
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalMessage').textContent = message;
            const buttonsContainer = document.getElementById('modalButtons');
            buttonsContainer.innerHTML = '';
            
            const acceptButton = document.createElement('button');
            acceptButton.textContent = buttonText;
            acceptButton.className = 'px-4 py-2 bg-blue-600 text-white font-semibold rounded-xl hover:bg-blue-700 transition duration-150';
            acceptButton.onclick = () => {
                hideModal();
                if (actionFunction) {
                    actionFunction();
                }
            };
            buttonsContainer.appendChild(acceptButton);
            modal.classList.add('modal-active');
        }

        function showConfirmModal(nextStepFunction) {
            const modal = document.getElementById('customModal');
            document.getElementById('modalTitle').textContent = 'Curso Agregado';
            document.getElementById('modalMessage').textContent = `El curso ha sido agregado a tu lista temporal. Tienes ${registeredCourses.length} de 3 cursos registrados. ¿Deseas inscribirte a otro curso?`;
            const buttonsContainer = document.getElementById('modalButtons');
            buttonsContainer.innerHTML = '';

            const finishButton = document.createElement('button');
            finishButton.textContent = 'No, finalizar registro';
            finishButton.className = 'px-4 py-2 bg-green-600 text-white font-semibold rounded-xl hover:bg-green-700 transition duration-150';
            finishButton.onclick = () => {
                hideModal();
                nextStepFunction(true); 
            };
            buttonsContainer.appendChild(finishButton);

            const continueButton = document.createElement('button');
            continueButton.textContent = 'Sí, agregar otro curso';
            continueButton.className = 'px-4 py-2 bg-blue-600 text-white font-semibold rounded-xl hover:bg-blue-700 transition duration-150';
            continueButton.onclick = () => {
                hideModal();
                nextStepFunction(false); 
            };
            buttonsContainer.appendChild(continueButton);
            modal.classList.add('modal-active');
        }

        function hideModal() {
            document.getElementById('customModal').classList.remove('modal-active');
        }


        // --- Lógica de Envío Multi-Curso ---

        aceptarButton.addEventListener('click', function(event) {
            event.preventDefault(); 
            
            // Forzar la validación de HTML5 para campos requeridos
            if (!form.checkValidity()) {
                form.reportValidity(); 
                return;
            }

            const formData = new FormData(form);
            const currentData = Object.fromEntries(formData.entries());

            // 1. VALIDACIONES DE INFORMACIÓN PERSONAL 
            // Esto solo se valida si es la primera inscripción O si los campos de identificación no están bloqueados
            // O si hay un campo que debe rellenarse
            if (registeredCourses.length === 0 || !document.getElementById('curp').readOnly || !document.getElementById('email').readOnly) {
                 // A. Validación de Email (Dominio específico)
                if (!validateEmailDomain(currentData.email)) {
                    showModal('Error de Validación', 'El correo electrónico debe ser de dominio @itdurango.edu.mx o @gmail.com.', 'Entendido');
                    return;
                }
                
                // B. Validación de Docente (solo se valida que el nombre exista en el DOCENTES_LIST)
                if (DOCENTES_LIST.length === 0) {
                    showModal('Cargando Datos', 'La base de datos de docentes aún se está cargando. Por favor, espera un momento y vuelve a intentarlo.', 'Entendido');
                    return;
                }
                
                const docenteError = validateDocenteExistence(currentData.curp, currentData.email, currentData.nombreCompleto);
                if (docenteError) {
                    showModal('Acceso Denegado', docenteError, 'Entendido');
                    return;
                }

                // Si las validaciones pasan, re-bloqueamos CURP y Email si es que ya tienen un valor.
                setPersonalInfoFieldsDisabled(true);
            }

            
            // Si ya tiene 3 cursos y presiona ACEPTAR, es para FINALIZAR el registro
            if (registeredCourses.length >= 3) {
                 startFinalSubmission();
                 return;
            }

            // 2. Validación de Traslape, Límite y Selección de Curso
            const overlapError = checkOverlap(currentData.cursoSeleccionado);
            if (overlapError) {
                showModal('Error de Inscripción', overlapError, 'Entendido');
                return;
            }
            
            // 3. Agregar curso a la lista temporal
            const courseDetails = COURSES.find(c => c.NombreCurso === currentData.cursoSeleccionado);
            
            registeredCourses.push({
                nombreCompleto: currentData.nombreCompleto,
                curp: currentData.curp,
                email: currentData.email,
                genero: currentData.genero,
                departamento: currentData.departamento,
                cursoSeleccionado: currentData.cursoSeleccionado,
                fechaVisible: courseDetails.FechaVisible || '',
                lugar: courseDetails.Lugar || '',
                horario: courseDetails.Horario || ''
            });
            localStorage.setItem('registeredCourses', JSON.stringify(registeredCourses));
            renderRegisteredCourses();
            
            // Limpiar curso seleccionado para la siguiente ronda
            document.getElementById('curso').value = '';
            updateCourseDetails();

            // 4. Determinar siguiente paso: ¿Añadir otro o finalizar?
            if (registeredCourses.length >= 3) {
                showModal('Límite Alcanzado', 'Has alcanzado el máximo de 3 cursos. Procede al envío final.', 'Continuar', startFinalSubmission);
            } else {
                showConfirmModal((isFinal) => {
                    if (isFinal) {
                        startFinalSubmission();
                    } 
                });
            }
        });


        // Función que inicia el proceso de envío secuencial de todos los cursos
        async function startFinalSubmission() {
            if (registeredCourses.length === 0) {
                showModal('Atención', 'No tienes cursos en tu lista de inscripción. Selecciona al menos uno.', 'Cerrar');
                return;
            }

            aceptarButton.disabled = true;
            aceptarButton.textContent = 'Enviando (1/3)...';

            let successCount = 0;

            for (let i = 0; i < registeredCourses.length; i++) {
                const courseData = registeredCourses[i];
                aceptarButton.textContent = `Enviando Curso ${i + 1} de ${registeredCourses.length}...`;

                try {
                    // Crear un FormData para el envío individual
                    const individualFormData = new FormData();
                    for (const key in courseData) {
                         // Asegurar que nombre y CURP estén en mayúsculas al enviar
                        if (key === 'nombreCompleto' || key === 'curp') {
                            individualFormData.append(key, (courseData[key] || '').toUpperCase());
                        } else {
                            individualFormData.append(key, courseData[key] || ''); 
                        }
                    }
                    
                    const response = await fetch(form.action, {
                        method: 'POST',
                        body: individualFormData,
                        mode: 'no-cors' 
                    });

                    successCount++;
                    console.log(`Envío de curso ${i + 1} completado.`);

                } catch (error) {
                    console.error("Error al enviar el curso:", courseData.cursoSeleccionado, error);
                }
            }
            
            // Lógica de finalización
            if (successCount === registeredCourses.length) {
                localStorage.removeItem('registeredCourses');
                registeredCourses = [];
                renderRegisteredCourses();
                successMessage.classList.remove('hidden');
                form.reset();
            } else {
                showModal('Error Parcial', `Solo se lograron enviar ${successCount} de ${registeredCourses.length} cursos. Revisa los detalles en tu lista y vuelve a intentarlo.`, 'Cerrar');
            }

            aceptarButton.disabled = false;
            aceptarButton.textContent = 'Aceptar';
        }

        // --- Inicialización ---
        window.onload = loadExternalData;

        // Asignar listeners de cambio
        document.getElementById('curso').addEventListener('change', updateCourseDetails);
        
        // Al interactuar con el campo NombreCompleto, forzar el re-autocompletado/chequeo del bloqueo
        document.getElementById('nombreCompleto').addEventListener('input', function() {
            // Si el usuario borra el campo, debemos re-habilitar todos
            if (this.value.trim() === '') {
                 setFieldDisabled(document.getElementById('curp'), false);
                 setFieldDisabled(document.getElementById('email'), false);
            }
        });


    </script>

</body>
</html>
