<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro de Cursos ITD</title>
    <!-- Incluye Tailwind CSS para un diseño moderno y responsive -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        /* Estilo para el modal */
        .modal {
            transition: opacity 0.3s ease-in-out;
        }
        .modal-active {
            opacity: 1;
            pointer-events: auto;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">

    <!-- Contenedor principal del formulario -->
    <div class="bg-white p-8 md:p-12 rounded-2xl shadow-2xl w-full max-w-4xl border border-gray-200">
        
        <!-- Encabezado con Logo -->
        <div class="flex justify-between items-start mb-8 border-b pb-4">
            <!-- Logo ITD (URL de GitHub) -->
            <img src="https://raw.githubusercontent.com/DA-itd/web/main/logo_itdurango.png" alt="Logo ITD" class="h-16 w-auto object-contain">
            <div class="text-right">
                <h2 class="text-xl font-semibold text-gray-700">INSTITUTO TECNOLOGICO DE DURANGO</h2>
                <h1 class="text-3xl font-bold text-gray-800">Registro de Cursos de Actualización Docente</h1>
            </div>
        </div>
        
        <p class="mb-6 text-center text-gray-600">Por favor, selecciona hasta 3 cursos. El sistema validará que no haya empalmes de horario.</p>

        <!-- Formulario -->
        <form id="registroForm" class="space-y-6" action="https://script.google.com/macros/s/AKfycbyxWZVL33x5pXJQ1jb6wLzWHEQ01Bug4ALTVT43xSSBzoZr1D5A58wlU4Tnvxj9AomY/exec" method="POST">
            <!-- Campos de Información Personal (Solo lectura después del primer curso) -->
            <div id="personalInfoFields" class="grid grid-cols-1 md:grid-cols-2 gap-6 p-4 border rounded-xl bg-blue-50/50">
                <!-- Nombre Completo -->
                <div>
                    <label for="nombreCompleto" class="block text-sm font-medium text-gray-700">Nombre Completo</label>
                    <input type="text" id="nombreCompleto" name="nombreCompleto" required class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-xl shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 uppercase" oninput="this.value = this.value.toUpperCase()">
                </div>

                <!-- CURP -->
                <div>
                    <label for="curp" class="block text-sm font-medium text-gray-700">CURP (Máx. 18 caracteres)</label>
                    <input type="text" id="curp" name="curp" maxlength="18" required class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-xl shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 uppercase" oninput="this.value = this.value.toUpperCase()">
                </div>

                <!-- Email -->
                <div>
                    <label for="email" class="block text-sm font-medium text-gray-700">Correo Electrónico (Solo @itdurango.edu.mx o @gmail.com)</label>
                    <input type="email" id="email" name="email" required class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-xl shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="usuario@itdurango.edu.mx">
                </div>

                <!-- Género -->
                <div>
                    <label for="genero" class="block text-sm font-medium text-gray-700">Género</label>
                    <select id="genero" name="genero" required class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-xl shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                        <option value="">Selecciona tu género</option>
                        <option value="Femenino">Femenino</option>
                        <option value="Masculino">Masculino</option>
                        <option value="Otro">Otro</option>
                    </select>
                </div>

                <!-- Departamento -->
                <div class="col-span-1 md:col-span-2">
                    <label for="departamento" class="block text-sm font-medium text-gray-700">Departamento</label>
                    <select id="departamento" name="departamento" required class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-xl shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                        <option value="">Selecciona un departamento</option>
                        <!-- Opciones pobladas por JavaScript -->
                    </select>
                </div>
            </div>

            <!-- Sección de Cursos a Inscribir -->
            <div class="p-4 border rounded-xl bg-green-50/50">
                <h3 class="text-lg font-semibold mb-4 text-gray-700">Inscripción a Curso Actual</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <!-- Campo: Curso Seleccionado -->
                    <div class="md:col-span-3">
                        <label for="curso" class="block text-sm font-medium text-gray-700">Curso a Inscribir</label>
                        <select id="curso" name="cursoSeleccionado" required class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-xl shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" onchange="updateCourseDetails()">
                            <option value="">Selecciona un curso</option>
                            <!-- Opciones pobladas por JavaScript -->
                        </select>
                    </div>

                    <!-- Campo: Fecha Visible (Se llena automáticamente) -->
                    <div>
                        <label for="fechaVisible" class="block text-sm font-medium text-gray-700">Fecha Visible</label>
                        <input type="text" id="fechaVisible" name="fechaVisible" readonly class="mt-1 block w-full px-4 py-2 border border-gray-200 bg-gray-100 rounded-xl shadow-sm">
                    </div>
                    
                    <!-- Campo: Lugar (Se llena automáticamente) -->
                    <div>
                        <label for="lugar" class="block text-sm font-medium text-gray-700">Lugar</label>
                        <input type="text" id="lugar" name="lugar" readonly class="mt-1 block w-full px-4 py-2 border border-gray-200 bg-gray-100 rounded-xl shadow-sm">
                    </div>

                    <!-- Campo: Horario (Se llena automáticamente) -->
                    <div>
                        <label for="horario" class="block text-sm font-medium text-gray-700">Horario</label>
                        <input type="text" id="horario" name="horario" readonly class="mt-1 block w-full px-4 py-2 border border-gray-200 bg-gray-100 rounded-xl shadow-sm">
                    </div>
                </div>
            </div>

            <!-- Lista de Cursos Registrados Temporalmente -->
            <div id="registeredCoursesContainer" class="p-4 border border-yellow-300 bg-yellow-50 rounded-xl hidden">
                <h3 class="text-lg font-semibold mb-2 text-gray-700">Cursos Agregados (Máx. 3)</h3>
                <ul id="registeredCoursesList" class="list-disc list-inside text-sm text-gray-600 ml-4">
                    <!-- Cursos agregados aquí -->
                </ul>
            </div>

            <!-- Botón de Envío -->
            <div class="pt-4">
                <button type="button" id="aceptarButton" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-xl shadow-sm text-lg font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-300 ease-in-out transform hover:scale-105">
                    Aceptar
                </button>
                <p id="error-message" class="mt-2 text-center text-red-600 font-medium hidden"></p>
            </div>
        </form>

        <!-- Mensaje de éxito final -->
        <div id="successMessage" class="mt-6 p-6 bg-green-100 text-green-800 rounded-xl hidden text-center">
            <h3 class="font-bold text-xl mb-2">¡Registro Completado con Éxito!</h3>
            <p class="mt-1">Tus cursos han sido inscritos. Recibirás un correo de confirmación por cada curso con tu código.</p>
        </div>
    </div>

    <!-- Modal Personalizado para el Flujo de Múltiples Cursos/Confirmación -->
    <div id="customModal" class="modal fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 opacity-0 pointer-events-none z-50">
        <div class="bg-white p-6 rounded-2xl shadow-xl w-full max-w-sm transform transition-all duration-300 scale-95 modal-content">
            <h4 id="modalTitle" class="text-lg font-bold text-gray-800 mb-4"></h4>
            <p id="modalMessage" class="text-gray-600 mb-6"></p>
            <div id="modalButtons" class="flex justify-end space-x-3">
                <!-- Botones generados por JS -->
            </div>
        </div>
    </div>

    <!-- JavaScript con Datos y Lógica -->
    <script>
        // Datos integrados (simulando carga de CSVs)
        const DEPARTMENTS = [
            "DEPARTAMENTO DE SISTEMAS Y COMPUTACION",
            "DEPARTAMENTO DE INGENIERÍA ELÉCTRICA Y ELECTRÓNICA",
            "DEPARTAMENTO DE CIENCIAS ECONOMICO-ADMINISTRATIVAS",
            "DEPARTAMENTO DE INGENIERÍA QUÍMICA-BIOQUÍMICA",
            "DEPARTAMENTO DE CIENCIAS DE LA TIERRA",
            "DEPARTAMENTO DE CIENCIAS BASICAS",
            "DEPARTAMENTO DE METAL-MECÁNICA",
            "DEPARTAMENTO DE INGENIERÍA INDUSTRIAL",
            "DIVISION DE ESTUDIOS DE POSGRADO E INVESTIGACION",
            "ADMINISTRATIVO",
            "EXTERNO"
        ];

        // Datos de Cursos (simulando Cursos.csv)
        const COURSES = [
            { id: 1, name: "CONOCIENDO REGLAMENTOS Y LINEAMIENTOS: UNA PAUTA PARA EL DESARROLLO DOCENTE Y PERFIL DESEABLE", date: "DEL 13 AL 17 DE ENERO DEL 2026", period: "PERIODO_1", hours: 30, location: "A4", schedule: "9:00 a 15:00 hrs" },
            { id: 2, name: "PYTHON BÁSICO", date: "DEL 13 AL 17 DE ENERO DEL 2026", period: "PERIODO_1", hours: 30, location: "Edifcio O", schedule: "9:00 a 15:00 hrs" },
            { id: 3, name: "MANTENIMIENTO CORRECTIVO FRESA CNC DYNA MYTE", date: "DEL 13 AL 17 DE ENERO DEL 2026", period: "PERIODO_1", hours: 30, location: "Lab. de Electrica", schedule: "9:00 a 15:00 hrs" },
            { id: 4, name: "HERRAMIENTAS DE INTELIGENCIA ARTIFICIAL GENERATIVA", date: "DEL 13 AL 17 DE ENERO DEL 2026", period: "PERIODO_1", hours: 30, location: "Lab. de Elen", schedule: "9:00 a 15:00 hrs" },
            { id: 5, name: "METODOLOGÍA DE EDUCACIÓN VIRTUAL /ITDED", date: "DEL 13 AL 17 DE ENERO DEL 2026", period: "PERIODO_1", hours: 30, location: "Centro de Información Sala A", schedule: "9:00 a 15:00 hrs" },
            { id: 6, name: "INGLES BÁSICO I", date: "DEL 20 AL 24 DE ENERO DEL 2026", period: "PERIODO_2", hours: 30, location: "Centro de Innovación", schedule: "9:00 a 15:00 hrs" },
            // Agregando algunos cursos de la segunda fecha para prueba de traslape
            { id: 7, name: "ESTRATEGIAS PARA EL DESARROLLO Y MEJORA DEL LABORATORIO DE INGENIERÍA CIVIL", date: "DEL 20 AL 24 DE ENERO DEL 2026", period: "PERIODO_2", hours: 30, location: "Lab. de Elen", schedule: "9:00 a 15:00 hrs" },
            { id: 8, name: "DISEÑO DE PROCESOS TÉRMICOS EN ALIMENTOS DE BAJA ACIDEZ", date: "DEL 20 AL 24 DE ENERO DEL 2026", period: "PERIODO_2", hours: 30, location: "UPIDET", schedule: "9:00 a 15:00 hrs" },
        ];

        let registeredCourses = JSON.parse(localStorage.getItem('registeredCourses')) || [];
        const form = document.getElementById('registroForm');
        const aceptarButton = document.getElementById('aceptarButton');
        const personalInfoFields = document.getElementById('personalInfoFields');
        const errorMessage = document.getElementById('error-message');
        const successMessage = document.getElementById('successMessage');

        // --- Funciones de Utilidad ---

        // Función para poblar los dropdowns
        function populateDropdowns() {
            const departamentoSelect = document.getElementById('departamento');
            const cursoSelect = document.getElementById('curso');

            // 1. Departamentos
            DEPARTMENTS.forEach(dept => {
                const option = document.createElement('option');
                option.value = dept;
                option.textContent = dept;
                departamentoSelect.appendChild(option);
            });

            // 2. Cursos
            COURSES.forEach(curso => {
                const option = document.createElement('option');
                option.value = curso.name;
                option.textContent = `${curso.name} (${curso.date} | ${curso.schedule})`;
                option.dataset.courseId = curso.id; // Almacenar ID para referencia
                cursoSelect.appendChild(option);
            });
        }

        // Función para actualizar los campos de fecha, lugar y horario
        function updateCourseDetails() {
            const cursoSelect = document.getElementById('curso');
            const selectedCourseName = cursoSelect.value;
            const curso = COURSES.find(c => c.name === selectedCourseName);

            document.getElementById('fechaVisible').value = curso ? curso.date : '';
            document.getElementById('lugar').value = curso ? curso.location : '';
            document.getElementById('horario').value = curso ? curso.schedule : '';
        }

        // Función para renderizar la lista de cursos registrados
        function renderRegisteredCourses() {
            const list = document.getElementById('registeredCoursesList');
            const container = document.getElementById('registeredCoursesContainer');
            list.innerHTML = '';
            
            if (registeredCourses.length > 0) {
                container.classList.remove('hidden');
                registeredCourses.forEach((reg, index) => {
                    const li = document.createElement('li');
                    li.innerHTML = `<strong>${reg.name}</strong> (${reg.date} - ${reg.schedule}) 
                                    <button onclick="removeCourse(${index})" class="ml-2 text-red-500 hover:text-red-700 text-xs font-bold transition duration-150">BORRAR</button>`;
                    list.appendChild(li);
                });
                
                // Deshabilitar campos de información personal después del primer registro
                const fields = personalInfoFields.querySelectorAll('input, select');
                fields.forEach(field => field.readOnly = true);

                if (registeredCourses.length >= 3) {
                    aceptarButton.textContent = 'FINALIZAR REGISTRO';
                } else {
                    aceptarButton.textContent = 'AÑADIR OTRO CURSO';
                }

            } else {
                container.classList.add('hidden');
                // Habilitar campos si no hay cursos registrados
                const fields = personalInfoFields.querySelectorAll('input, select');
                fields.forEach(field => field.readOnly = false);
                aceptarButton.textContent = 'Aceptar'; // Vuelve al texto inicial
            }
        }

        // Función para eliminar un curso de la lista temporal
        function removeCourse(index) {
            registeredCourses.splice(index, 1);
            localStorage.setItem('registeredCourses', JSON.stringify(registeredCourses));
            renderRegisteredCourses();
            updateCourseDetails(); // Para limpiar el campo si es necesario
            showModal('Curso Eliminado', 'El curso fue eliminado de tu lista temporal. Puedes seleccionar otro.', 'Aceptar');
        }
        window.removeCourse = removeCourse; // Hace la función accesible desde el onclick en el HTML

        // Función de validación de correo electrónico
        function validateEmail(email) {
            const regex = /^[a-zA-Z0-9._%+-]+@((itdurango\.edu\.mx)|(gmail\.com))$/i;
            return regex.test(email);
        }

        // Función de validación de traslape
        function checkOverlap(newCourse) {
            const newCourseData = COURSES.find(c => c.name === newCourse);
            if (!newCourseData) return null; // Curso no encontrado

            // Regla de no empalme de Fecha y Horario
            const overlap = registeredCourses.find(reg => 
                reg.date === newCourseData.date && reg.schedule === newCourseData.schedule
            );
            
            if (overlap) {
                return `El curso se empalma con "${overlap.name}", que tiene la misma fecha y horario (${overlap.date} | ${overlap.schedule}).`;
            }

            // Regla de máximo 3 cursos
            if (registeredCourses.length >= 3) {
                return "Has alcanzado el límite máximo de 3 cursos.";
            }

            // Regla de máximo 2 cursos con mismo horario (aunque en fechas diferentes) - NO es clara y se omite para enfocarse en la restricción fuerte.
            // Para simplificar, nos enfocamos en el traslape directo (fecha y hora).

            return null; // No hay errores
        }
        
        // Función para mostrar el modal
        function showModal(title, message, buttonText, actionFunction = null) {
            const modal = document.getElementById('customModal');
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalMessage').textContent = message;
            const buttonsContainer = document.getElementById('modalButtons');
            buttonsContainer.innerHTML = '';
            
            const acceptButton = document.createElement('button');
            acceptButton.textContent = buttonText;
            acceptButton.className = 'px-4 py-2 bg-blue-600 text-white font-semibold rounded-xl hover:bg-blue-700 transition duration-150';
            acceptButton.onclick = () => {
                hideModal();
                if (actionFunction) {
                    actionFunction();
                }
            };
            buttonsContainer.appendChild(acceptButton);

            modal.classList.add('modal-active');
        }

        // Función para mostrar el modal de confirmación de otro curso
        function showConfirmModal(nextStepFunction) {
            const modal = document.getElementById('customModal');
            document.getElementById('modalTitle').textContent = 'Curso Agregado';
            document.getElementById('modalMessage').textContent = `El curso ha sido agregado a tu lista temporal. Tienes ${registeredCourses.length} de 3 cursos registrados. ¿Deseas inscribirte a otro curso?`;
            const buttonsContainer = document.getElementById('modalButtons');
            buttonsContainer.innerHTML = '';

            // Botón: No, finalizar registro
            const finishButton = document.createElement('button');
            finishButton.textContent = 'No, finalizar registro';
            finishButton.className = 'px-4 py-2 bg-green-600 text-white font-semibold rounded-xl hover:bg-green-700 transition duration-150';
            finishButton.onclick = () => {
                hideModal();
                nextStepFunction(true); // Indica que es el final
            };
            buttonsContainer.appendChild(finishButton);

            // Botón: Sí, agregar otro curso
            const continueButton = document.createElement('button');
            continueButton.textContent = 'Sí, agregar otro curso';
            continueButton.className = 'px-4 py-2 bg-blue-600 text-white font-semibold rounded-xl hover:bg-blue-700 transition duration-150';
            continueButton.onclick = () => {
                hideModal();
                nextStepFunction(false); // Indica que no es el final
            };
            buttonsContainer.appendChild(continueButton);

            modal.classList.add('modal-active');
        }

        // Función para ocultar el modal
        function hideModal() {
            document.getElementById('customModal').classList.remove('modal-active');
        }


        // --- Lógica de Envío Multi-Curso ---

        aceptarButton.addEventListener('click', function(event) {
            event.preventDefault(); // Detener el envío de formulario tradicional
            errorMessage.classList.add('hidden');

            if (!form.checkValidity()) {
                form.reportValidity(); // Muestra los errores de validación HTML5
                return;
            }

            const formData = new FormData(form);
            const currentData = Object.fromEntries(formData.entries());

            // 1. Validación de Email (Dominio específico)
            if (!validateEmail(currentData.email)) {
                showModal('Error de Validación', 'El correo electrónico debe ser de dominio @itdurango.edu.mx o @gmail.com.', 'Entendido');
                return;
            }

            // 2. Validación de Traslape y Límite
            const overlapError = checkOverlap(currentData.cursoSeleccionado);
            if (overlapError) {
                showModal('Error de Inscripción', overlapError, 'Entendido');
                return;
            }
            
            // 3. Agregar curso a la lista temporal
            const courseDetails = COURSES.find(c => c.name === currentData.cursoSeleccionado);
            if (registeredCourses.some(reg => reg.name === courseDetails.name)) {
                showModal('Error', 'Este curso ya está en tu lista de inscripciones temporales.', 'Entendido');
                return;
            }

            registeredCourses.push({
                ...currentData,
                date: courseDetails.date,
                schedule: courseDetails.schedule
            });
            localStorage.setItem('registeredCourses', JSON.stringify(registeredCourses));
            renderRegisteredCourses();
            
            // 4. Determinar siguiente paso: ¿Añadir otro o finalizar?
            if (registeredCourses.length >= 3) {
                // Límite alcanzado, pasar a la función de envío final
                showModal('Límite de Cursos', 'Has alcanzado el máximo de 3 cursos. Procede al envío final.', 'Continuar', startFinalSubmission);
            } else {
                // Preguntar si desea otro curso
                showConfirmModal((isFinal) => {
                    if (isFinal) {
                        startFinalSubmission();
                    } else {
                        // Limpiar solo los campos de curso para la siguiente selección
                        document.getElementById('curso').value = '';
                        updateCourseDetails();
                    }
                });
            }
        });


        // Función que inicia el proceso de envío secuencial de todos los cursos
        async function startFinalSubmission() {
            if (registeredCourses.length === 0) {
                showModal('Atención', 'No tienes cursos en tu lista de inscripción.', 'Cerrar');
                return;
            }

            aceptarButton.disabled = true;
            aceptarButton.textContent = 'Enviando (1/3)...';

            let allSuccessful = true;
            let successCount = 0;

            for (let i = 0; i < registeredCourses.length; i++) {
                const courseData = registeredCourses[i];
                aceptarButton.textContent = `Enviando (${i + 1}/${registeredCourses.length})...`;

                try {
                    // Crear un FormData para el envío individual
                    const individualFormData = new FormData();
                    for (const key in courseData) {
                        individualFormData.append(key, courseData[key]);
                    }
                    
                    // Nota: Se usa fetch para evitar recargar la página y poder enviar múltiples veces
                    const response = await fetch(form.action, {
                        method: 'POST',
                        body: individualFormData,
                        mode: 'no-cors' // Necesario para el endpoint de Apps Script
                    });

                    // Apps Script no devuelve JSON/respuesta HTTP estándar con mode: 'no-cors',
                    // pero un simple éxito en la promesa de fetch indica que el envío se inició.
                    successCount++;
                    console.log(`Envío de curso ${i + 1} completado.`);

                } catch (error) {
                    console.error("Error al enviar el curso:", courseData.name, error);
                    allSuccessful = false;
                    // Continuar con el resto de los envíos a pesar de un error
                }
            }
            
            // Lógica de finalización
            if (allSuccessful) {
                localStorage.removeItem('registeredCourses');
                registeredCourses = [];
                renderRegisteredCourses();
                successMessage.classList.remove('hidden');
                form.reset();
            } else {
                showModal('Error Parcial', `Se enviaron ${successCount} de ${registeredCourses.length} cursos. Revisa tu lista y vuelve a intentarlo.`, 'Cerrar');
            }

            aceptarButton.disabled = false;
            aceptarButton.textContent = 'Aceptar';
        }

        // --- Inicialización ---
        window.onload = function() {
            populateDropdowns();
            renderRegisteredCourses();
            updateCourseDetails(); // Para limpiar los detalles iniciales
            
            // Asignar el listener de cambio para actualizar detalles
            document.getElementById('curso').addEventListener('change', updateCourseDetails);

            // Escuchar el cambio en el formulario para deshabilitar campos después del primer registro (por si el usuario manipula el localStorage)
            form.addEventListener('change', () => {
                if (registeredCourses.length > 0) {
                    const fields = personalInfoFields.querySelectorAll('input, select');
                    fields.forEach(field => {
                        if (field.id !== 'curso' && field.id !== 'fechaVisible' && field.id !== 'lugar' && field.id !== 'horario') {
                            field.readOnly = true;
                            field.classList.add('bg-gray-100');
                        }
                    });
                } else {
                     const fields = personalInfoFields.querySelectorAll('input, select');
                    fields.forEach(field => {
                        field.readOnly = false;
                        field.classList.remove('bg-gray-100');
                    });
                }
            });

            // Forzar la validación de readOnly al inicio
            renderRegisteredCourses();
        };

    </script>

</body>
</html>
